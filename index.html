<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0f172a" />
  <title>Stone‑Age Eating Simulator</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --muted:#9ca3af;       /* gray-400 */
      --text:#e5e7eb;        /* gray-200 */
      --brand:#22c55e;       /* green-500 */
      --brand-2:#38bdf8;     /* sky-400 */
      --accent:#f59e0b;      /* amber-500 */
      --card:#0b1220;        /* custom */
      --ring: 0 0 0 2px rgba(56,189,248,.5);
      color-scheme: dark;
      font-synthesis-weight:none;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 700px at 10% -10%,#0b1530,transparent),var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:rgba(255,255,255,0)}
    .wrap{max-width:1100px;margin:0 auto;padding:calc(20px + env(safe-area-inset-top)) 20px 20px 20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    h1{font-size:28px;margin:0}
    .sub{color:var(--muted);font-size:13px}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(148,163,184,.15);border-radius:14px}
    .controls{display:grid;grid-template-columns:1fr;gap:16px;padding:16px}
    @media(min-width:700px){.controls{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:12px;color:#cbd5e1;margin-bottom:6px}
    input[type=number],select{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.25);background:#0a1222;color:var(--text);outline:none;min-height:44px}
    input[type=number]:focus,select:focus{box-shadow:var(--ring);border-color:#38bdf8}
    .btns{display:flex;flex-wrap:wrap;gap:12px;padding:0 16px 16px}
    button{appearance:none;border:0;border-radius:14px;padding:12px 16px;font-weight:600;cursor:pointer;color:#081018;min-height:44px}
    .b-sec{background:linear-gradient(135deg,var(--brand-2),#0891b2)}
    .grid{display:grid;gap:16px}
    @media(min-width:860px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));border:1px solid rgba(148,163,184,.12);border-radius:14px;padding:16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .kcal{font-size:26px;font-weight:700}
    .muted{color:var(--muted)}
    .list{margin:8px 0 0 0;padding-left:18px}
    .list li{margin:2px 0}
    /* macro bar */
    .macrobar{display:flex;height:18px;width:180px;border-radius:6px;overflow:hidden;margin-left:auto}
    .macrobar div{height:100%}
    .protein{background:#22c55e}
    .fat{background:#38bdf8}
    .carbs{background:#f59e0b}
    .barwrap{height:160px}
    .bar{height:100%;display:flex;align-items:flex-end;gap:8px}
    .bar div{flex:1;min-width:20px;background:linear-gradient(180deg,var(--brand-2),#0ea5e9);border-radius:8px 8px 0 0;position:relative}
    .bar div span{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);font-size:11px;color:var(--muted)}
    .footer{color:#94a3b8;font-size:12px;text-align:center;margin:20px 0;padding-bottom:env(safe-area-inset-bottom)}
    @media(prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Stone‑Age Eating Simulator</h1>
        <div class="sub">Seasonal foods of Central Europe • Irregular days, steady weekly average.</div>
      </div>
    </header>

    <section class="panel" aria-label="Settings">
      <div class="controls">
        <div>
          <label for="target">Daily target (kcal)</label>
          <input id="target" type="number" inputmode="numeric" min="1000" max="6000" step="50" placeholder="2400" />
        </div>
        <div>
          <label for="season">Season</label>
          <select id="season" aria-label="Select season">
            <option>Spring</option>
            <option>Summer</option>
            <option>Autumn</option>
            <option>Winter</option>
          </select>
        </div>
      </div>
      <div class="btns">
        <!-- Single button: roll the entire week -->
        <button class="b-sec" id="week" aria-label="Roll a full week">Roll a week</button>
      </div>
    </section>

    <section style="margin-top:16px">
      <div class="grid" id="cards"></div>
    </section>

    <section class="panel" style="margin-top:16px">
      <div class="card" style="background:transparent">
        <div class="row" style="margin-bottom:8px"><strong>History (kcal)</strong><span class="muted" id="meanLabel"></span></div>
        <div class="barwrap"><div class="bar" id="bar"></div></div>
      </div>
    </section>

    <div class="footer">© <span id="year"></span> – Simulation for irregular intake.</div>
  </div>

  <script>
  // ---------- Utilities ----------
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
  const rnd = (min, max) => min + Math.random() * (max - min);
  const uid = () => Math.random().toString(36).slice(2,9);
  const round = (n, d=0) => {const p = 10**d; return Math.round(n*p)/p};

  // constraints for week generation
  const WEEK_TOL = 0.05;      // ±5% around target mean
  const MAX_ATTEMPTS = 200;   // cap to avoid endless loops

  // ---------- Data (Central Europe, by season) ----------
  const P = (name,k,p,f,c,seasons)=>({name,kcalPer100:k,p,f,c,seasons});

  const foods = {
    protein:[
      // Beef: two variants with distinct macros
      P("Beef (ground)",234,18,18,0,["Spring","Summer","Autumn","Winter"]),
      P("Beef steak",149,21,7,0,["Spring","Summer","Autumn","Winter"]),
      // Poultry and Fish
      P("Poultry",108,24.4,1.1,0,["Spring","Summer","Autumn","Winter"]),
      P("Fish",200,20,13,0,["Spring","Summer","Autumn","Winter"]),
    ],
    fat:[
      P("Hazelnuts",628,15,61,17,["Autumn","Winter","Spring"]),
      P("Beechnuts",576,6,50,33,["Autumn","Winter","Spring"]),
      P("Seeds",559,30,49,11,["All"]),
    ],
    carbs:[
      P("Raspberries",52,1,1,12,["Summer"]),
      P("Blackberries",43,1,0,10,["Summer","Autumn"]),
      P("Strawberries",33,1,0,8,["Spring","Summer"]),
      P("Blueberries",57,1,0,14,["Summer"]),
      P("Elderberries",73,1,1,18,["Autumn"]),
      P("Lingonberries",46,0,0,12,["Autumn"]),
      P("Apples",52,0,0,14,["Autumn","Winter","Spring"]),
      P("Pears",57,0,0,15,["Autumn","Winter","Spring"]),
      P("Cherries",63,1,0,16,["Summer"]),
      P("Plums",46,1,0,11,["Summer","Autumn"]),
      P("Carrots",41,1,0,10,["All"]),
      P("Parsnips",75,1,0,18,["Autumn","Winter","Spring"]),
      P("Celery",42,1,0,9,["Autumn","Winter","Spring"]),
      P("Beetroot",43,2,0,10,["Autumn","Winter","Spring"]),
    ]
  };

  // Macro ranges per season & day type (tilted toward animal intake)
  const macroRanges = {
    Spring: { lean:{p:[0.24,0.34],f:[0.30,0.40],c:[0.24,0.34]}, normal:{p:[0.26,0.36],f:[0.32,0.42],c:[0.20,0.30]}, rich:{p:[0.28,0.40],f:[0.36,0.46],c:[0.14,0.26]} },
    Summer: { lean:{p:[0.22,0.32],f:[0.28,0.40],c:[0.24,0.34]}, normal:{p:[0.24,0.36],f:[0.32,0.44],c:[0.18,0.28]}, rich:{p:[0.28,0.40],f:[0.36,0.48],c:[0.12,0.24]} },
    Autumn: { lean:{p:[0.24,0.34],f:[0.32,0.42],c:[0.20,0.30]}, normal:{p:[0.26,0.38],f:[0.34,0.46],c:[0.16,0.26]}, rich:{p:[0.30,0.42],f:[0.38,0.50],c:[0.12,0.22]} },
    Winter: { lean:{p:[0.26,0.36],f:[0.34,0.46],c:[0.16,0.26]}, normal:{p:[0.28,0.40],f:[0.36,0.50],c:[0.12,0.22]}, rich:{p:[0.30,0.44],f:[0.38,0.52],c:[0.10,0.20]} },
  };

  // Hidden defaults (kept internal)
  const DEFAULTS = {
    probs: { lean: 3, normal: 3, rich: 1 },
    mults: { lean: 0.55, normal: 1.0, rich: 1.55 },
    target: 2400,
    season: 'Summer'
  };

  // ---------- Local storage ----------
  const store = {
    get(){ try{ return JSON.parse(localStorage.getItem('saesim')||'{}'); }catch{ return {}; } },
    set(data){ localStorage.setItem('saesim', JSON.stringify(data)); }
  };

  const state = { history: [], settings: { target: DEFAULTS.target, season: DEFAULTS.season } };

  function loadFromStorage(){
    const s = store.get();
    if(s.settings){ state.settings = { ...state.settings, ...s.settings }; }
    if(Array.isArray(s.history)){ state.history = s.history; }
  }
  function saveToStorage(){ store.set({ settings: state.settings, history: state.history }); }

  // ---------- Portion logic (realistic ranges) ----------
  function portionRangeFor(name){
    // grams [min, max]
    if(/Beef/.test(name)) return [150, 1000];
    if(/Fish|Poultry/.test(name)) return [150, 500];
    if(/Hazelnuts|Beechnuts|Nuts/.test(name)) return [20, 40];
    if(/Seeds/.test(name)) return [15, 30];
    if(/Carrots|Parsnips|Celery|Beetroot/.test(name)) return [120, 250];
    if(/Apples|Pears/.test(name)) return [130, 200];
    if(/Cherries|Plums/.test(name)) return [100, 200];
    if(/Raspberries|Blackberries|Strawberries|Blueberries|Elderberries|Lingonberries/.test(name)) return [80, 200];
    return [80, 300];
  }

  // ---------- Mechanics ----------
  function seasonal(list, season){
    let r = list.filter(x => x.seasons.includes('All') || x.seasons.includes(season));
    if(!r.length) r = list.filter(x => x.seasons.includes('All'));
    if(!r.length) r = list.slice();
    return r;
  }
  function weightedPick(weights){ const entries = Object.entries(weights); const total = entries.reduce((a,[,w])=>a+w,0); let r = Math.random()*total, acc=0; for(const [k,w] of entries){ acc+=w; if(r<=acc) return k; } return 'normal'; }
  function drawMacroSplit(season, type){ const r = macroRanges[season][type]; let proteinPct=rnd(r.p[0],r.p[1]); let fatPct=rnd(r.f[0],r.f[1]); let carbPct=1-proteinPct-fatPct; carbPct=clamp(carbPct,r.c[0],r.c[1]); const sum=proteinPct+fatPct+carbPct; return { proteinPct:proteinPct/sum, fatPct:fatPct/sum, carbPct:carbPct/sum }; }
  function gramsFromKcal(kcal, m){ return { protein:(kcal*m.proteinPct)/4, fat:(kcal*m.fatPct)/9, carbs:(kcal*m.carbPct)/4 }; }

  function pick(arr){ return (arr && arr.length) ? arr[Math.floor(Math.random()*arr.length)] : null; }
  function pickUnique(arr, used){ if(!arr || !arr.length) return null; const pool = arr.filter(x => x && !used.has(x.name)); return pool.length ? pick(pool) : null; }

  function foodItem(f, grams){ const kcal = f.kcalPer100/100 * grams; return { name:f.name, grams:round(grams), kcal:round(kcal) }; }
  function macrosOf(f, grams){ return { p: grams*(f.p/100), f: grams*(f.f/100), c: grams*(f.c/100) }; }

  function planFoods(targetKcal, grams, season){
    const pList = seasonal(foods.protein, season);
    const fList = seasonal(foods.fat, season);
    const cList = seasonal(foods.carbs, season);
    const used = new Set();
    const items = [];
    const provided = { p:0, f:0, c:0 };

    function add(f, g){ const m = macrosOf(f,g); provided.p+=m.p; provided.f+=m.f; provided.c+=m.c; items.push(foodItem(f,g)); used.add(f.name); }

    // Decide animal group for the whole day: Fish OR Meat (Beef/Poultry)
    const isFishDay = Math.random() < 0.5;
    const meats = pList.filter(x => /Beef|Poultry/.test(x.name));
    const fishes = pList.filter(x => /Fish/.test(x.name));
    const animal = isFishDay ? fishes[0] : pick(meats) || meats[0];

    // PRIMARY ANIMAL (single item for the day)
    if(animal){
      const [minG, maxG] = portionRangeFor(animal.name);
      const needP = grams.protein / (animal.p/100);
      let g = clamp(needP, minG, maxG);
      add(animal, g);
    }

    // FAT SLOT — prefer plant fats; if none, skip
    {
      const ff = pickUnique(fList, used);
      if(ff){
        const [minG, maxG] = portionRangeFor(ff.name);
        const fatDef = Math.max(0, grams.fat - provided.f);
        if(fatDef > 5){
          const need = fatDef / (ff.f/100);
          const g = clamp(need, minG, maxG);
          add(ff, g);
        }
      }
    }

    // CARB SLOT(S) — keep to 1–2 plant sources, capped
    {
      let fc1 = pickUnique(cList, used) || pick(cList);
      if(fc1){
        let [min1, max1] = portionRangeFor(fc1.name);
        const cDef1 = Math.max(0, grams.carbs - provided.c);
        const need1 = cDef1>0 ? cDef1 / (fc1.c/100) : min1;
        const g1 = clamp(need1, min1, max1);
        add(fc1, g1);

        const cRemain = Math.max(0, grams.carbs - provided.c);
        if(cRemain > 20){
          const remaining = cList.filter(x => x && !used.has(x.name));
          let fc2 = remaining.length ? pick(remaining) : null;
          if(fc2){
            const [min2, max2] = portionRangeFor(fc2.name);
            const need2 = cRemain / (fc2.c/100);
            const g2 = clamp(need2, min2, Math.min(max2, 300));
            add(fc2, g2);
          }
        }
      }
    }

    // ENERGY TOP‑UP — prefer carbs or plant fats; do not add another animal item
    const kcalNow = items.reduce((a,b)=>a+b.kcal,0);
    if(kcalNow < targetKcal*0.9){
      const missing = targetKcal - kcalNow;
      const extras = cList.filter(x=>!used.has(x.name));
      let ex = extras.length ? pick(extras) : pick(cList);
      if(!ex){ ex = pick(fList); }
      if(ex){
        const [minE, maxE] = portionRangeFor(ex.name);
        const g = clamp((missing/ex.kcalPer100)*100, Math.max(minE, 50), Math.min(maxE, 250));
        add(ex, g);
      }
    }

    return items;
  }

  function drawMacroSplit(season, type){ const r = macroRanges[season][type]; let proteinPct=rnd(r.p[0],r.p[1]); let fatPct=rnd(r.f[0],r.f[1]); let carbPct=1-proteinPct-fatPct; carbPct=clamp(carbPct,r.c[0],r.c[1]); const sum=proteinPct+fatPct+carbPct; return { proteinPct:proteinPct/sum, fatPct:fatPct/sum, carbPct:carbPct/sum }; }
  function gramsFromKcal(kcal, m){ return { protein:(kcal*m.proteinPct)/4, fat:(kcal*m.fatPct)/9, carbs:(kcal*m.carbPct)/4 }; }

  function makeDay({type, target, season, multiplier, label}){
    const kcal = Math.max(500, round(target * multiplier));
    const macros = drawMacroSplit(season, type);
    const grams = gramsFromKcal(kcal, macros);
    const foodsSel = planFoods(kcal, grams, season);
    return { id:uid(), label, type, kcal, macros,
      grams:{ protein:round(grams.protein), fat:round(grams.fat), carbs:round(grams.carbs) },
      foods: foodsSel };
  }

  function generateWeek(target, season){
    const labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const days = [];
    for(let i=0;i<7;i++){
      const t = weightedPick(DEFAULTS.probs);
      days.push(makeDay({ type:t, target, season, multiplier:DEFAULTS.mults[t], label:labels[i] }));
    }
    const tooBig = days.some(d => d.kcal > 2*target);
    const sum = days.reduce((a,d)=>a+d.kcal,0);
    const mean = sum/7;
    const within = Math.abs(mean - target) <= target * WEEK_TOL;
    return { days, mean, tooBig, within };
  }

  function makeWeek(){
    const target = state.settings.target;
    const season = state.settings.season;
    let best = null; let bestScore = Infinity;

    for(let attempt=1; attempt<=MAX_ATTEMPTS; attempt++){
      const cand = generateWeek(target, season);
      const score = (cand.tooBig ? 1e6 : 0) + Math.abs(cand.mean - target);
      if(score < bestScore){ best = cand; bestScore = score; }
      if(!cand.tooBig && cand.within){ best = cand; break; }
    }

    state.history = best ? best.days : [];
    render();
    saveToStorage();
  }

  // ---------- UI ----------
  const elTarget = document.getElementById('target');
  const elSeason = document.getElementById('season');
  const elCards = document.getElementById('cards');
  const elBar = document.getElementById('bar');
  const elMean = document.getElementById('meanLabel');

  function setupInputs(){
    elTarget.value = state.settings.target;
    elSeason.value = state.settings.season;

    elTarget.addEventListener('change', ()=>{
      const v = parseInt(elTarget.value, 10);
      if(!isNaN(v)){
        state.settings.target = clamp(v, 1000, 6000);
        elTarget.value = state.settings.target;
        saveToStorage();
        render();
      }
    });

    elSeason.addEventListener('change', ()=>{ state.settings.season = elSeason.value; saveToStorage(); render(); });

    document.getElementById('week').addEventListener('click', makeWeek);
  }

  function macroBar(d){
    const p = Math.round(d.macros.proteinPct*100);
    const f = Math.round(d.macros.fatPct*100);
    const c = 100 - p - f;
    return `<div class="macrobar"><div class="protein" style="width:${p}%"></div><div class="fat" style="width:${f}%"></div><div class="carbs" style="width:${c}%"></div></div>`;
  }

  function render(){
    elCards.innerHTML = '';
    const list = state.history;
    for(const d of list){
      const card = document.createElement('div'); card.className = 'card';
      card.innerHTML = `
        <div class="row" style="margin-bottom:8px">
          <strong style="text-transform:capitalize">${d.type}</strong>
          <span class="muted">${d.label}</span>
        </div>
        <div class="row" style="align-items:flex-start; gap:12px">
          <div>
            <div class="kcal">${d.kcal} <span class="muted" style="font-weight:500;font-size:14px">kcal</span></div>
            <div class="muted" style="font-size:13px">P: ${d.grams.protein} g · F: ${d.grams.fat} g · C: ${d.grams.carbs} g</div>
          </div>
          <div class="legend" style="text-align:right">
            <div><span style="display:inline-block;width:10px;height:10px;background:#22c55e;border-radius:2px;margin-right:6px"></span>Protein</div>
            <div><span style="display:inline-block;width:10px;height:10px;background:#38bdf8;border-radius:2px;margin-right:6px"></span>Fat</div>
            <div><span style="display:inline-block;width:10px;height:10px;background:#f59e0b;border-radius:2px;margin-right:6px"></span>Carbs</div>
          </div>
          ${macroBar(d)}
        </div>
        <ul class="list">${d.foods.map(f=>`<li>${escapeHtml(f.name)} – ${f.grams} g (~${f.kcal} kcal)</li>`).join('')}</ul>
      `;
      elCards.appendChild(card);
    }

    // History barchart
    elBar.innerHTML = '';
    const data = state.history;
    const max = Math.max(1, ...data.map(d=>d.kcal));
    data.forEach((d)=>{
      const b = document.createElement('div');
      b.style.height = (d.kcal/max*100)+"%";
      b.innerHTML = `<span>${d.kcal}</span>`;
      elBar.appendChild(b);
    });

    const mean = data.length? Math.round(data.reduce((a,d)=>a+d.kcal,0)/data.length) : 0;
    elMean.textContent = data.length? `mean of ${data.length} day(s): ${mean} kcal (target ${state.settings.target})` : 'no data yet';
  }

  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  // ---------- Boot ----------
  document.getElementById('year').textContent = new Date().getFullYear();
  loadFromStorage();
  setupInputs();
  render();
  </script>
</body>
</html>
